import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import io
import re
from openpyxl import Workbook, load_workbook
from openpyxl.styles import PatternFill, Alignment, Font
from openpyxl.worksheet.table import Table, TableStyleInfo

# 1. Configuraci贸n de la p谩gina
st.set_page_config(page_title="NI-Force Database Manager", layout="wide")
st.title(" Procesador de Fuerza NI - Gesti贸n de Historial Local")
st.markdown("""
Esta herramienta permite actualizar tu propia base de datos. 
1. Sube tu archivo Excel actual (si ya tienes uno). 
2. Sube los nuevos archivos CSV. 
3. Descarga el archivo actualizado.
""")

# 2. Barra lateral
st.sidebar.header(" Datos del Sujeto")
id_sujeto = st.sidebar.text_input("ID Sujeto (NIxx)", value="NI00", max_chars=4).strip().upper()
es_id_valido = bool(re.match(r"^NI\d{2}$", id_sujeto))

nombre_sesion = st.sidebar.text_input("Sesi贸n", "Sesi贸n_A").strip()
serie_inicial = st.sidebar.number_input("Empezar en Serie n潞", min_value=1, value=1)

st.sidebar.header("锔 Ajustes de An谩lisis")
sens_inicio = st.sidebar.slider("Inicio (N/s)", 10, 2000, 40)
sens_final_pendiente = st.sidebar.slider("Final (Sensibilidad)", -1000, -5, -10)
recorte = st.sidebar.slider("Recorte (s)", 1.0, 10.0, 5.0)
umbral_corte = st.sidebar.number_input("Valor X final (N)", value=25.0)

# Colores pastel para distinguir sujetos
COLORES_PASTEL = ["FFEBEE", "E3F2FD", "F1F8E9", "FFF3E0", "F3E5F5", "E0F7FA", "FFFDE7", "F9FBE7", "E8EAF6", "EFEBE9"]

def estilizar_excel(df, output):
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, index=False, sheet_name='Resultados')
        ws = writer.sheets['Resultados']
        
        # Tabla inteligente
        ref = f"A1:{chr(64 + len(df.columns))}{len(df) + 1}"
        tab = Table(displayName="DB_Fuerza", ref=ref)
        tab.tableStyleInfo = TableStyleInfo(name="TableStyleMedium2", showRowStripes=True)
        ws.add_table(tab)
        
        # Colores por ID
        ids = df['Sujeto'].unique().tolist()
        mapa = {id: COLORES_PASTEL[i % len(COLORES_PASTEL)] for i, id in enumerate(ids)}
        for row in range(2, ws.max_row + 1):
            color = mapa.get(ws.cell(row=row, column=2).value, "FFFFFF")
            fill = PatternFill(start_color=color, end_color=color, fill_type="solid")
            for col in range(1, len(df.columns) + 1):
                ws.cell(row=row, column=col).fill = fill
                ws.cell(row=row, column=col).alignment = Alignment(horizontal="center")
        for col in ws.columns: ws.column_dimensions[col[0].column_letter].width = 16
    return output

# --- INTERFAZ DE CARGA ---
col_db, col_csv = st.columns(2)

with col_db:
    st.subheader("1. Tu Base de Datos (.xlsx)")
    excel_file = st.file_uploader("Opcional: Sube tu Excel actual para a帽adir datos", type="xlsx")

with col_csv:
    st.subheader("2. Nuevos Archivos (.csv)")
    csv_files = st.file_uploader("Sube los archivos CSV de hoy", type="csv", accept_multiple_files=True)

if csv_files:
    nuevas_reps = []
    st.divider()
    
    for idx, arc in enumerate(csv_files):
        try:
            serie_act = serie_inicial + idx
            df_raw = pd.read_csv(arc, sep=';', header=None)
            t = pd.to_numeric(df_raw[0], errors='coerce').values / 1_000_000.0
            f = pd.to_numeric(df_raw[1].astype(str).str.replace(',', '.'), errors='coerce').values
            mask = ~np.isnan(t) & ~np.isnan(f)
            t, f = t[mask], f[mask]
            
            # Pendiente para detecci贸n de RFD: $$\text{Pendiente} = \frac{\Delta F}{\Delta t}$$
            pend = np.gradient(f) / np.gradient(t)
            
            inicios, en_accion = [], False
            for i in range(1, len(pend)):
                if pend[i] > sens_inicio and not en_accion:
                    inicios.append(i); en_accion = True
                elif f[i] < (umbral_corte / 2) and en_accion:
                    en_accion = False
            
            for i, idx_ini in enumerate(inicios):
                t_c = t[idx_ini] + recorte
                idxs_f = np.where((t > t_c) & (f < umbral_corte))[0]
                if len(idxs_f) > 0:
                    idx_f = idxs_f[0]
                    for j in range(idx_f, idx_ini, -1):
                        if pend[j] > sens_final_pendiente:
                            idx_f = j; break
                    
                    m_m = (t >= t_c) & (t <= t[idx_f])
                    if len(f[m_m]) > 3:
                        nuevas_reps.append({
                            'Fecha': pd.Timestamp.now().strftime('%Y-%m-%d %H:%M'),
                            'Sujeto': id_sujeto,
                            'Sesi贸n': nombre_sesion,
                            'SERIE': int(serie_act),
                            'REPETICIN': i + 1,
                            'Media(N)': round(np.mean(f[m_m]), 2),
                            'Max(N)': round(np.max(f[m_m]), 2)
                        })
        except Exception as e:
            st.error(f"Error en {arc.name}: {e}")

    if nuevas_reps:
        df_nuevas = pd.DataFrame(nuevas_reps)
        
        # L贸gica de Fusi贸n
        if excel_file:
            df_historial = pd.read_excel(excel_file)
            df_final = pd.concat([df_historial, df_nuevas], ignore_index=True)
            st.success(f"Se han a帽adido {len(df_nuevas)} repeticiones al historial cargado.")
        else:
            df_final = df_nuevas
            st.info("Creando un nuevo historial con estas repeticiones.")

        st.dataframe(df_final.tail(10), use_container_width=True) # Ver las 煤ltimas 10

        # Bot贸n de Descarga
        buffer = io.BytesIO()
        estilizar_excel(df_final, buffer)
        
        st.download_button(
            label=" DESCARGAR BASE DE DATOS ACTUALIZADA",
            data=buffer.getvalue(),
            file_name=f"DB_Fuerza_{id_sujeto}.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            use_container_width=True
        )